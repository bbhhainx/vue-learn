<template>
  <!-- <TiptapEditor
    :uploadImage="uploadImage"
    v-model="content"
    :type_content="'markdown'"
  />
  <br />
  <br /> -->

  <button class="bg-red-100 h-dvh w-dvw overflow-hidden">
    <div
      class="zoomable overflow-hidden flex justify-center items-center bg-white h-[500px]"
      id="gesture-area"
      ref="gesture_area"
    >
      <div
        id="scale-element"
        ref="scale_element"
        class="bg-slate-100 w-full h-full"
      >
        <TiptapEditor :model-value="content" :type_editor="'view'" />
      </div>
    </div>
  </button>
  <!-- <div id="gesture-area">
    <div class="w-[50dvw] h-[50dvh] rounded-full bg-red-500" id="scale-element"></div>
  </div> -->

  <!-- <br />
  <br />
  <strong>Preview</strong>
  <ViewEditor :content="content" :type_content="'markdown'" />
  <br />
  <br />
  <strong>N·ªôi dung raw</strong>
  <p>{{ content }}</p> -->
</template>

<script setup lang="ts">
import { nextTick, onMounted, ref, watch } from "vue";
import ViewEditor from "../components/tiptap/ViewEditor.vue";
import TiptapEditor from "../components/tiptap/TiptapEditor.vue";

import interact from "interactjs";

/** n·ªôi dung */
const content = ref(`Hello\n\n**Xin ch√†o**`);

watch(
  () => content.value,
  (newContent) => {
    console.log("N·ªôi dung ƒë√£ thay ƒë·ªïi:", newContent);
  }
);

// üëâ H√†m upload gi·∫£ l·∫≠p
function uploadImage(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      const succeed = Math.random() > 0.2; // 80% success
      if (succeed)
        // resolve(URL.createObjectURL(file)); // demo th√¥i, thay b·∫±ng link th·∫≠t
        resolve(
          "https://cubanvr.com/wp-content/uploads/2023/07/ai-image-generators.webp"
        );
      else reject(new Error("Upload failed"));
    }, 1500);
  });
}

/** khu v·ª±c thao t√°c */
const gesture_area = ref<HTMLDivElement | null>(null);
/** ph·∫ßn t·ª≠ ƒëu·ª£c zoom */
const scale_element = ref<HTMLDivElement | null>(null);
/** t·ªâ l·ªá zoom */
const scale = ref(1);
/** ƒë·ªãa ch·ªâ timeout */
let reset_timeout: number | undefined;

onMounted(async () => {
  // ƒë·ª£i ch·ªù DOM c·∫≠p nh·∫≠t
  await nextTick();

  // n·∫øu kh√¥ng c√≥ gesture_area th√¨ kh√¥ng th√¥i
  if (!gesture_area.value || !scale_element.value) return;

  interact(gesture_area.value).gesturable({
    listeners: {
      start(event) {
        // xo√° timeout n·∫øu c√≥
        clearTimeout(reset_timeout);

        // xo√° class reset n·∫øu c√≥
        scale_element.value?.classList.remove("reset");
      },
      move(event) {
        // n·∫øu kh√¥ng c√≥ ph·∫ßn t·ª≠ c·∫ßn zoom th√¨ kh√¥ng l√†m g√¨
        if (!scale_element.value) return;

        /** t·ªâ l·ªá scale hi·ªán t·∫°i */
        const CURRENT_SCALE = event.scale * scale.value;

        // c·∫≠p nh·∫≠t t·ªâ l·ªá zoom
        scale_element.value.style.transform =
          "scale(" + Math.max(CURRENT_SCALE, 1) + ")";

        // c·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa ph·∫ßn t·ª≠ ƒëang zoom
        dragMoveListener(event);
      },
      end(event) {
        // n·∫øu kh√¥ng c√≥ ph·∫ßn t·ª≠ c·∫ßn zoom th√¨ kh√¥ng l√†m g√¨
        if (!scale_element.value) return;

        // c·∫≠p nh·∫≠t t·ªâ l·ªá zoom
        scale.value = scale.value * event.scale;

        // sau 300ms th√¨ reset v·ªã tr√≠ v√† t·ªâ l·ªá zoom
        reset_timeout = setTimeout(reset, 300);

        // th√™m class reset ƒë·ªÉ c√≥ hi·ªáu ·ª©ng
        scale_element.value.classList.add("reset");
      },
    },
  });
});

/** h√†m reset t·ªâ l·ªá zoom */
function reset() {
  // n·∫øu kh√¥ng c√≥ ph·∫ßn t·ª≠ c·∫ßn zoom th√¨ kh√¥ng l√†m g√¨
  if (!scale_element.value) return;

  // ƒë·∫∑t l·∫°i t·ªâ l·ªá zoom v·ªÅ 1
  scale_element.value.style.transform = "scale(1)";

  // ƒë·∫∑t l·∫°i gi√° tr·ªã v·ªÅ 1
  scale.value = 1;
}

/** h√†m c·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa ph·∫ßn t·ª≠ c·∫ßn zoom */
function dragMoveListener(event: any) {
  // n·∫øu kh√¥ng c√≥ ph·∫ßn t·ª≠ c·∫ßn zoom th√¨ kh√¥ng l√†m g√¨
  if (!scale_element.value) return;

  /** v·ªã tr√≠ theo tr·ª•c ho√†ng */
  const POSITION_X =
    parseFloat(scale_element.value.getAttribute("data-x") || "0") + event.dx;
  /** v·ªã tr√≠ theo tr·ª•c tung */
  const POSITION_Y =
    parseFloat(scale_element.value.getAttribute("data-y") || "0") + event.dy;

  // c·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa ph·∫ßn t·ª≠ c·∫ßn zoom
  scale_element.value.style.transform =
    scale_element.value.style.transform +
    "translate(" +
    POSITION_X +
    "px, " +
    POSITION_Y +
    "px)";

  // c·∫≠p nh·∫≠t thu·ªôc t√≠nh data-x v√† data-y
  scale_element.value.setAttribute("data-x", POSITION_X);
  scale_element.value.setAttribute("data-y", POSITION_Y);
}
</script>

<style>
#scale-element {
  display: block;
  max-width: 100%;
  margin: 1rem auto;
  touch-action: none;
}

#scale-element.reset {
  transition: transform 0.3s ease-in-out;
}
</style>
